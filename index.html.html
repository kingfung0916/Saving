<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜ç®¡ç†ç³»çµ±</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5D5CDE">
    <meta name="description" content="å°ˆæ¥­çš„QR codeåº«å­˜ç®¡ç†ç³»çµ±">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5bqr5a2Y566h55CG57O757WxIiwic2hvcnRfbmFtZSI6IuW6q+Wtmuezu+e1sSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjRkZGRkZGIiwidGhlbWVfY29sb3IiOiIjNUQ1Q0RFIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU16SWlJR2hsYVdkb2REMGlNeklpSUhabGNuTnBiMjQ5SWpFdU1TSWdlRzFzYm5NOUltaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabklqNDhjbVZqZENCM2FXUjBhRDBpTXpJaUlHaGxhV2RvZEQwaU16SWlJR1pwYkd3OUlpVTFSRFZEUkVVaUx6NDhkR1Y0ZENCNFBTSXhOaUlnZVQwaU1UUWlJR1pwYkd3OUlpTkdSa1pHUmtZaUlHWnZiblF0YzJsNlpUMGlNVEJqZUNJZ2RHVjRkQzFoYm1Ob2IzSTlJbTFwWkdSc1pTSStVVklnUTI5a1pUd3ZkR1Y0ZEQ0OEwzTjJaejRnIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjMya3giLCJwdXJwb3NlIjoiYW55In0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdkbVZ5YzJsdmJqMGlNUzR4SWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4eVpXTjBJSGRwWkhSb1BTSTFNVElpSUdobGFXZG9kRDBpTlRFeUlpQm1hV3hzUFNJbE5VUTFRMFJGU1NJdlBqeDBaWGgwSUhnOUlqSTFOaUlnZVQwaU1qVTFJaUJtYVd4c1BTSWpSa1pHUmtaR0lpQm1iMjUwTFhOcGVtVTlJak16WTNnaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQbEZTSUVOdlpHVThMM1JsZUhRK1BDOXpkbWMrIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjUxMngiLCJwdXJwb3NlIjoiYW55In1dLCJzY29wZSI6Ii8iLCJsYW5nIjoidGgtVFciLCJkaXIiOiJsdHIiLCJjYXRlZ29yaWVzIjpbImJ1c2luZXNzIiwidG9vbHMiLCJwcm9kdWN0aXZpdHkiXX0=">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="åº«å­˜ç®¡ç†">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiU1RDVDREUiLz48dGV4dCB4PSIxNiIgeT0iMTQiIGZpbGw9IiNGRkZGRkYiIGZvbnQtc2l6ZT0iMTBjeCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UVIgQ29kZTwvdGV4dD48L3N2Zz4g">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'light-bg': '#FFFFFF',
                        'dark-bg': '#181818'
                    }
                }
            }
        }
    </script>
    <style>
        .scanner-frame {
            position: relative;
            width: 250px;
            height: 250px;
            border: 2px solid #5D5CDE;
            border-radius: 12px;
            margin: 0 auto;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .dark .scanner-frame {
            background: linear-gradient(45deg, #333 25%, transparent 25%), 
                        linear-gradient(-45deg, #333 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #333 75%), 
                        linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .scanner-corners::before,
        .scanner-corners::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #5D5CDE;
        }
        
        .scanner-corners::before {
            top: 10px;
            left: 10px;
            border-right: none;
            border-bottom: none;
        }
        
        .scanner-corners::after {
            bottom: 10px;
            right: 10px;
            border-left: none;
            border-top: none;
        }
        
        .scan-line {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #5D5CDE, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { transform: translateY(0); }
            100% { transform: translateY(210px); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">åº«å­˜ç®¡ç†ç³»çµ±</h1>
            <p class="text-gray-600 dark:text-gray-400">æƒæQR codeé€²è¡Œåº«å­˜è¨˜éŒ„èˆ‡æ¸…é»</p>
        </div>

        <!-- Scanner Section -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 text-center">QR Code æƒæå™¨</h2>
            
            <!-- Camera Scanner -->
            <div id="cameraSection" class="text-center mb-4">
                <div class="scanner-frame scanner-corners mx-auto mb-4 overflow-hidden">
                    <video id="videoElement" autoplay playsinline class="w-full h-full object-cover rounded-lg" style="display: none;"></video>
                    <canvas id="canvasElement" class="w-full h-full object-cover" style="display: none;"></canvas>
                    <div id="scanAnimation" class="scan-line"></div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button 
                        id="cameraBtn"
                        onclick="toggleCamera()" 
                        class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-medium"
                    >
                        ğŸ“· é–‹å•Ÿæ”åƒé ­
                    </button>
                    <button 
                        id="switchCameraBtn"
                        onclick="switchCamera()" 
                        class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium"
                        style="display: none;"
                    >
                        ğŸ”„ åˆ‡æ›æ”åƒé ­
                    </button>
                </div>
                
                <div id="cameraStatus" class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                    <p>ğŸ“± é»æ“Šã€Œé–‹å•Ÿæ”åƒé ­ã€é–‹å§‹æƒæQR code</p>
                </div>
            </div>
            
            <!-- Manual Input -->
            <div class="text-center space-y-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                <p class="text-sm text-gray-600 dark:text-gray-400">æˆ–æ‰‹å‹•è¼¸å…¥QR codeå…§å®¹</p>
                <div class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
                    <input 
                        type="text" 
                        id="qrInput" 
                        placeholder="è¼¸å…¥QR codeå…§å®¹..." 
                        class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    >
                    <button 
                        onclick="processManualQRCode()" 
                        class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors font-medium"
                    >
                        è™•ç†
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
            <button 
                onclick="showAddItemModal()" 
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg transition-colors font-medium"
            >
                â• æ–°å¢å•†å“
            </button>
            <button 
                onclick="startInventoryCheck()" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition-colors font-medium"
            >
                ğŸ“‹ é–‹å§‹æ¸…é»
            </button>
            <button 
                onclick="exportInventory()" 
                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg transition-colors font-medium"
            >
                ğŸ“„ åŒ¯å‡ºCSV
            </button>
            <button 
                onclick="saveData()" 
                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg transition-colors font-medium"
            >
                ğŸ’¾ å„²å­˜è³‡æ–™
            </button>
        </div>

        <!-- Data Management -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">è³‡æ–™ç®¡ç†</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="file" 
                    id="fileInput" 
                    accept=".json"
                    class="hidden"
                    onchange="loadData()"
                >
                <button 
                    onclick="document.getElementById('fileInput').click()" 
                    class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors font-medium"
                >
                    ğŸ“ è¼‰å…¥è³‡æ–™
                </button>
                <button 
                    onclick="autoBackup()" 
                    class="flex-1 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors font-medium"
                >
                    ğŸ”„ è‡ªå‹•å‚™ä»½: <span id="autoBackupStatus">é—œé–‰</span>
                </button>
                <button 
                    onclick="clearAllData()" 
                    class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors font-medium"
                >
                    ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™
                </button>
            </div>
            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                <p>ğŸ’¡ è³‡æ–™æœƒä»¥JSONæª”æ¡ˆæ ¼å¼å„²å­˜ï¼Œå¯ä»¥åœ¨ä¸åŒè£ç½®é–“åŒæ­¥ä½¿ç”¨</p>
                <p id="lastSaved" class="text-xs mt-1"></p>
            </div>
        </div>

        <!-- Inventory List -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">åº«å­˜æ¸…å–®</h2>
                    <div class="flex gap-3">
                        <select 
                            id="filterCategory" 
                            onchange="filterInventory()" 
                            class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        >
                            <option value="">æ‰€æœ‰é¡åˆ¥</option>
                        </select>
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="æœå°‹å•†å“..." 
                            onkeyup="filterInventory()" 
                            class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        >
                    </div>
                </div>
            </div>
            
            <div id="inventoryList" class="p-6">
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <p>å°šç„¡åº«å­˜è³‡æ–™</p>
                    <p class="text-sm mt-2">è«‹æƒæQR codeæˆ–æ–°å¢å•†å“é–‹å§‹ç®¡ç†åº«å­˜</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-lg font-semibold text-gray-900 dark:text-white">æ–°å¢å•†å“</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">âœ•</button>
                </div>
                
                <form id="itemForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">QR Code</label>
                        <input type="text" id="itemQR" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å•†å“åç¨± *</label>
                        <input type="text" id="itemName" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é¡åˆ¥</label>
                        <select id="itemCategory" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="é›»å­ç”¢å“">é›»å­ç”¢å“</option>
                            <option value="æœé£¾">æœé£¾</option>
                            <option value="é£Ÿå“">é£Ÿå“</option>
                            <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ•¸é‡ *</label>
                        <input type="number" id="itemQuantity" required min="0" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å–®åƒ¹</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å‚™è¨»</label>
                        <textarea id="itemNotes" rows="3" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-colors">
                            å„²å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global state
        let inventory = [];
        let currentEditingId = null;
        let isInventoryCheck = false;
        let autoBackupEnabled = false;
        let autoBackupInterval = null;

        // Process QR Code
        function processQRCode() {
            const qrCode = document.getElementById('qrInput').value.trim();
            if (!qrCode) {
                alert('è«‹è¼¸å…¥QR codeå…§å®¹');
                return;
            }

            const existingItem = inventory.find(item => item.qrCode === qrCode);
            
            if (existingItem) {
                if (isInventoryCheck) {
                    existingItem.checkCount = (existingItem.checkCount || 0) + 1;
                    showNotification(`å·²è¨˜éŒ„æ¸…é»ï¼š${existingItem.name} (${existingItem.checkCount})`);
                } else {
                    showItemModal(existingItem);
                }
            } else {
                showItemModal({ qrCode });
            }
            
            document.getElementById('qrInput').value = '';
            renderInventory();
        }

        // Show add/edit modal
        function showAddItemModal() {
            showItemModal({});
        }

        function showItemModal(item = {}) {
            currentEditingId = item.id || null;
            
            document.getElementById('modalTitle').textContent = item.id ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“';
            document.getElementById('itemQR').value = item.qrCode || '';
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('itemCategory').value = item.category || 'å…¶ä»–';
            document.getElementById('itemQuantity').value = item.quantity || '';
            document.getElementById('itemPrice').value = item.price || '';
            document.getElementById('itemNotes').value = item.notes || '';
            
            document.getElementById('itemModal').classList.remove('hidden');
            document.getElementById('itemModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('itemModal').classList.add('hidden');
            document.getElementById('itemModal').classList.remove('flex');
            currentEditingId = null;
        }

        // Handle form submission
        document.getElementById('itemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                qrCode: document.getElementById('itemQR').value || generateQRCode(),
                name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                price: parseFloat(document.getElementById('itemPrice').value) || 0,
                notes: document.getElementById('itemNotes').value,
                lastUpdated: new Date().toISOString()
            };

            if (currentEditingId) {
                const index = inventory.findIndex(item => item.id === currentEditingId);
                inventory[index] = { ...inventory[index], ...formData };
                showNotification('å•†å“å·²æ›´æ–°');
            } else {
                formData.id = Date.now().toString();
                formData.checkCount = 0;
                inventory.push(formData);
                showNotification('å•†å“å·²æ–°å¢');
            }

            updateCategories();
            renderInventory();
            autoSaveOnChange();
            closeModal();
        });

        // Generate random QR code
        function generateQRCode() {
            return 'QR' + Date.now().toString().slice(-8);
        }

        // Start inventory check
        function startInventoryCheck() {
            isInventoryCheck = !isInventoryCheck;
            const button = event.target;
            
            if (isInventoryCheck) {
                button.textContent = 'ğŸ›‘ çµæŸæ¸…é»';
                button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                button.classList.add('bg-red-500', 'hover:bg-red-600');
                
                // Reset check counts
                inventory.forEach(item => item.checkCount = 0);
                showNotification('æ¸…é»æ¨¡å¼å·²é–‹å§‹');
            } else {
                button.textContent = 'ğŸ“‹ é–‹å§‹æ¸…é»';
                button.classList.remove('bg-red-500', 'hover:bg-red-600');
                button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                showNotification('æ¸…é»æ¨¡å¼å·²çµæŸ');
            }
            
            renderInventory();
        }

        // Export inventory
        function exportInventory() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `åº«å­˜æ¸…å–®_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('åº«å­˜å·²åŒ¯å‡º');
        }

        function generateCSV() {
            const headers = ['QR Code', 'å•†å“åç¨±', 'é¡åˆ¥', 'æ•¸é‡', 'å–®åƒ¹', 'ç¸½åƒ¹å€¼', 'æ¸…é»æ•¸é‡', 'å·®ç•°', 'å‚™è¨»', 'æœ€å¾Œæ›´æ–°'];
            const rows = inventory.map(item => [
                item.qrCode,
                item.name,
                item.category,
                item.quantity,
                item.price,
                (item.quantity * item.price).toFixed(2),
                item.checkCount || 0,
                (item.checkCount || 0) - item.quantity,
                item.notes || '',
                new Date(item.lastUpdated).toLocaleString('zh-TW')
            ]);
            
            return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        }

        // Filter inventory
        function filterInventory() {
            const category = document.getElementById('filterCategory').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = inventory.filter(item => {
                const matchesCategory = !category || item.category === category;
                const matchesSearch = !search || 
                    item.name.toLowerCase().includes(search) ||
                    item.qrCode.toLowerCase().includes(search) ||
                    (item.notes && item.notes.toLowerCase().includes(search));
                
                return matchesCategory && matchesSearch;
            });
            
            renderFilteredInventory(filtered);
        }

        // Update category options
        function updateCategories() {
            const categories = [...new Set(inventory.map(item => item.category))];
            const select = document.getElementById('filterCategory');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">æ‰€æœ‰é¡åˆ¥</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        // Render inventory
        function renderInventory() {
            renderFilteredInventory(inventory);
        }

        function renderFilteredInventory(items) {
            const container = document.getElementById('inventoryList');
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“</p>
                    </div>
                `;
                return;
            }

            const totalValue = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            container.innerHTML = `
                <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-600 dark:text-gray-400">å•†å“ç¸½æ•¸:</span>
                            <span class="text-lg font-bold text-gray-900 dark:text-white ml-2">${items.length}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600 dark:text-gray-400">ç¸½åº«å­˜é‡:</span>
                            <span class="text-lg font-bold text-gray-900 dark:text-white ml-2">${items.reduce((sum, item) => sum + item.quantity, 0)}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600 dark:text-gray-400">ç¸½åƒ¹å€¼:</span>
                            <span class="text-lg font-bold text-green-600 dark:text-green-400 ml-2">$${totalValue.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    ${items.map(item => createItemCard(item)).join('')}
                </div>
            `;
        }

        function createItemCard(item) {
            const stockStatus = item.quantity <= 5 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
            const checkDiff = (item.checkCount || 0) - item.quantity;
            const checkStatus = checkDiff === 0 ? 'text-green-600' : checkDiff > 0 ? 'text-blue-600' : 'text-red-600';
            
            return `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <h3 class="font-semibold text-gray-900 dark:text-white">${item.name}</h3>
                                <span class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full">${item.category}</span>
                                ${item.quantity <= 5 ? '<span class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-full">åº«å­˜ä¸è¶³</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                <div>QR: <span class="font-mono">${item.qrCode}</span></div>
                                <div>åº«å­˜: <span class="${stockStatus} font-medium">${item.quantity}</span> | å–®åƒ¹: $${item.price.toFixed(2)} | ç¸½å€¼: $${(item.quantity * item.price).toFixed(2)}</div>
                                ${isInventoryCheck ? `<div>æ¸…é»: <span class="${checkStatus} font-medium">${item.checkCount || 0}</span> (å·®ç•°: ${checkDiff > 0 ? '+' : ''}${checkDiff})</div>` : ''}
                                ${item.notes ? `<div>å‚™è¨»: ${item.notes}</div>` : ''}
                                <div class="text-xs">æœ€å¾Œæ›´æ–°: ${new Date(item.lastUpdated).toLocaleString('zh-TW')}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="adjustQuantity('${item.id}', -1)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">-</button>
                            <button onclick="adjustQuantity('${item.id}', 1)" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors text-sm">+</button>
                            <button onclick="showItemModal(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">ç·¨è¼¯</button>
                            <button onclick="deleteItem('${item.id}')" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-sm">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Adjust quantity
        function adjustQuantity(id, change) {
            const item = inventory.find(item => item.id === id);
            if (item) {
                item.quantity = Math.max(0, item.quantity + change);
                item.lastUpdated = new Date().toISOString();
                renderInventory();
                showNotification(`${item.name} æ•¸é‡å·²${change > 0 ? 'å¢åŠ ' : 'æ¸›å°‘'}`);
            }
        }

        // Delete item
        function deleteItem(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) {
                const index = inventory.findIndex(item => item.id === id);
                if (index > -1) {
                    const item = inventory[index];
                    inventory.splice(index, 1);
                    updateCategories();
                    renderInventory();
                    showNotification(`${item.name} å·²åˆªé™¤`);
                }
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Camera and QR Code Functions
        let stream = null;
        let scanning = false;
        let currentFacingMode = 'environment';
        let cameras = [];

        // Manual QR Code processing
        function processManualQRCode() {
            const qrCode = document.getElementById('qrInput').value.trim();
            if (!qrCode) {
                showErrorNotification('è«‹è¼¸å…¥QR codeå…§å®¹');
                return;
            }
            processQRResult(qrCode);
            document.getElementById('qrInput').value = '';
        }

        // Process QR code result (from camera or manual input)
        function processQRResult(qrCode) {
            const existingItem = inventory.find(item => item.qrCode === qrCode);
            
            if (existingItem) {
                if (isInventoryCheck) {
                    existingItem.checkCount = (existingItem.checkCount || 0) + 1;
                    showNotification(`âœ… å·²è¨˜éŒ„æ¸…é»ï¼š${existingItem.name} (${existingItem.checkCount})`);
                    // åœ¨æ¸…é»æ¨¡å¼ä¸‹æ’­æ”¾éŸ³æ•ˆå›é¥‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    playBeepSound();
                } else {
                    stopCamera(); // åœæ­¢æ”åƒé ­
                    showItemModal(existingItem);
                }
            } else {
                stopCamera(); // åœæ­¢æ”åƒé ­
                showItemModal({ qrCode });
            }
            
            renderInventory();
        }

        // Toggle camera on/off
        async function toggleCamera() {
            if (stream) {
                stopCamera();
            } else {
                await startCamera();
            }
        }

        // Start camera
        async function startCamera() {
            try {
                updateCameraStatus('æ­£åœ¨å•Ÿå‹•æ”åƒé ­...', 'info');
                
                // Get available cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(device => device.kind === 'videoinput');
                
                if (cameras.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°å¯ç”¨çš„æ”åƒé ­');
                }

                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('videoElement');
                const canvas = document.getElementById('canvasElement');
                
                video.srcObject = stream;
                video.style.display = 'block';
                canvas.style.display = 'none';
                document.getElementById('scanAnimation').style.display = 'block';
                
                // Update UI
                document.getElementById('cameraBtn').textContent = 'ğŸ“· é—œé–‰æ”åƒé ­';
                document.getElementById('cameraBtn').classList.remove('bg-green-500', 'hover:bg-green-600');
                document.getElementById('cameraBtn').classList.add('bg-red-500', 'hover:bg-red-600');
                
                if (cameras.length > 1) {
                    document.getElementById('switchCameraBtn').style.display = 'block';
                }
                
                updateCameraStatus('æ”åƒé ­å·²å•Ÿå‹•ï¼Œæ­£åœ¨æƒæQR code...', 'success');
                
                // Start scanning
                scanning = true;
                scanQRCode();
                
            } catch (error) {
                console.error('æ”åƒé ­å•Ÿå‹•å¤±æ•—:', error);
                updateCameraStatus(`æ”åƒé ­å•Ÿå‹•å¤±æ•—ï¼š${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    updateCameraStatus('è«‹å…è¨±ç¶²ç«™ä½¿ç”¨æ”åƒé ­æ¬Šé™', 'error');
                } else if (error.name === 'NotFoundError') {
                    updateCameraStatus('æœªæ‰¾åˆ°æ”åƒé ­è¨­å‚™', 'error');
                } else {
                    updateCameraStatus('æ”åƒé ­ä¸å¯ç”¨ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥', 'warning');
                }
            }
        }

        // Stop camera
        function stopCamera() {
            scanning = false;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            const video = document.getElementById('videoElement');
            video.style.display = 'none';
            document.getElementById('canvasElement').style.display = 'none';
            document.getElementById('scanAnimation').style.display = 'block';
            
            document.getElementById('cameraBtn').textContent = 'ğŸ“· é–‹å•Ÿæ”åƒé ­';
            document.getElementById('cameraBtn').classList.remove('bg-red-500', 'hover:bg-red-600');
            document.getElementById('cameraBtn').classList.add('bg-green-500', 'hover:bg-green-600');
            document.getElementById('switchCameraBtn').style.display = 'none';
            
            updateCameraStatus('æ”åƒé ­å·²é—œé–‰', 'info');
        }

        // Switch camera (front/back)
        async function switchCamera() {
            if (cameras.length <= 1) return;
            
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            
            if (stream) {
                stopCamera();
                await startCamera();
            }
        }

        // Scan QR code from video
        function scanQRCode() {
            if (!scanning || !stream) return;
            
            const video = document.getElementById('videoElement');
            const canvas = document.getElementById('canvasElement');
            const context = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    // QR code detected
                    scanning = false;
                    updateCameraStatus(`âœ… QR code æƒææˆåŠŸï¼š${code.data}`, 'success');
                    processQRResult(code.data);
                    
                    // çŸ­æš«é¡¯ç¤ºæƒææˆåŠŸæ•ˆæœ
                    canvas.style.display = 'block';
                    video.style.display = 'none';
                    document.getElementById('scanAnimation').style.display = 'none';
                    
                    // ç¹ªåˆ¶æƒææ¡†
                    drawQRBounds(context, code.location);
                    
                    // 1ç§’å¾Œæ¢å¾©æƒææˆ–é—œé–‰æ”åƒé ­
                    setTimeout(() => {
                        if (isInventoryCheck) {
                            // æ¸…é»æ¨¡å¼ä¸‹ç¹¼çºŒæƒæ
                            video.style.display = 'block';
                            canvas.style.display = 'none';
                            document.getElementById('scanAnimation').style.display = 'block';
                            scanning = true;
                            scanQRCode();
                        } else {
                            // éæ¸…é»æ¨¡å¼ä¸‹é—œé–‰æ”åƒé ­
                            stopCamera();
                        }
                    }, 1000);
                    
                    return;
                }
            }
            
            // Continue scanning
            if (scanning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // Draw QR code bounds
        function drawQRBounds(context, location) {
            context.strokeStyle = '#5D5CDE';
            context.lineWidth = 4;
            context.beginPath();
            context.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
            context.lineTo(location.topRightCorner.x, location.topRightCorner.y);
            context.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
            context.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
            context.closePath();
            context.stroke();
        }

        // Update camera status
        function updateCameraStatus(message, type = 'info') {
            const statusElement = document.getElementById('cameraStatus');
            const colors = {
                success: 'text-green-600 dark:text-green-400',
                error: 'text-red-600 dark:text-red-400',
                warning: 'text-yellow-600 dark:text-yellow-400',
                info: 'text-gray-600 dark:text-gray-400'
            };
            
            statusElement.innerHTML = `<p class="${colors[type]}">${message}</p>`;
        }

        // Play beep sound for successful scan
        function playBeepSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                // å¦‚æœéŸ³é »ä¸å¯ç”¨ï¼Œéœé»˜å¤±æ•—
                console.log('Audio not available');
            }
        }

        // Handle Enter key in QR input
        document.getElementById('qrInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processManualQRCode();
            }
        });

        // Clean up camera when page unloads
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stopCamera();
            }
        });

        // Data Storage Functions
        function saveData() {
            const dataToSave = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                inventory: inventory,
                metadata: {
                    totalItems: inventory.length,
                    categories: [...new Set(inventory.map(item => item.category))],
                    lastModified: new Date().toISOString()
                }
            };

            const dataStr = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `åº«å­˜è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            updateLastSavedTime();
            showNotification('è³‡æ–™å·²å„²å­˜');
        }

        function loadData() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.inventory && Array.isArray(data.inventory)) {
                        if (inventory.length > 0) {
                            if (confirm('è¼‰å…¥æ–°è³‡æ–™æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                                inventory = data.inventory;
                                updateCategories();
                                renderInventory();
                                updateLastSavedTime(data.timestamp);
                                showNotification(`æˆåŠŸè¼‰å…¥ ${inventory.length} é …å•†å“`);
                            }
                        } else {
                            inventory = data.inventory;
                            updateCategories();
                            renderInventory();
                            updateLastSavedTime(data.timestamp);
                            showNotification(`æˆåŠŸè¼‰å…¥ ${inventory.length} é …å•†å“`);
                        }
                    } else {
                        showErrorNotification('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                    }
                } catch (error) {
                    showErrorNotification('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            fileInput.value = '';
        }

        function autoBackup() {
            autoBackupEnabled = !autoBackupEnabled;
            const statusSpan = document.getElementById('autoBackupStatus');
            
            if (autoBackupEnabled) {
                statusSpan.textContent = 'é–‹å•Ÿ';
                statusSpan.parentElement.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                statusSpan.parentElement.classList.add('bg-green-500', 'hover:bg-green-600');
                
                // æ¯5åˆ†é˜è‡ªå‹•å‚™ä»½ä¸€æ¬¡
                autoBackupInterval = setInterval(() => {
                    if (inventory.length > 0) {
                        saveData();
                        showNotification('è‡ªå‹•å‚™ä»½å®Œæˆ');
                    }
                }, 5 * 60 * 1000);
                
                showNotification('è‡ªå‹•å‚™ä»½å·²é–‹å•Ÿï¼ˆæ¯5åˆ†é˜ï¼‰');
            } else {
                statusSpan.textContent = 'é—œé–‰';
                statusSpan.parentElement.classList.remove('bg-green-500', 'hover:bg-green-600');
                statusSpan.parentElement.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                
                if (autoBackupInterval) {
                    clearInterval(autoBackupInterval);
                    autoBackupInterval = null;
                }
                
                showNotification('è‡ªå‹•å‚™ä»½å·²é—œé–‰');
            }
        }

        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åº«å­˜è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                if (confirm('è«‹å†æ¬¡ç¢ºèªï¼šé€™æœƒåˆªé™¤æ‰€æœ‰å•†å“è³‡æ–™ï¼')) {
                    inventory = [];
                    updateCategories();
                    renderInventory();
                    updateLastSavedTime();
                    showNotification('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º');
                }
            }
        }

        function updateLastSavedTime(timestamp = null) {
            const lastSavedElement = document.getElementById('lastSaved');
            if (timestamp) {
                lastSavedElement.textContent = `æœ€å¾Œå„²å­˜: ${new Date(timestamp).toLocaleString('zh-TW')}`;
            } else if (inventory.length > 0) {
                lastSavedElement.textContent = `æœ€å¾Œå„²å­˜: ${new Date().toLocaleString('zh-TW')}`;
            } else {
                lastSavedElement.textContent = '';
            }
        }

        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Enhanced notification for data operations
        function enhancedNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, type === 'error' ? 5000 : 3000);
        }

        // Auto-save on data changes
        function autoSaveOnChange() {
            if (autoBackupEnabled && inventory.length > 0) {
                // å»¶é²1ç§’å¾Œè‡ªå‹•ä¿å­˜ï¼Œé¿å…é »ç¹æ“ä½œ
                setTimeout(() => {
                    updateLastSavedTime();
                }, 1000);
            }
        }

        // Override existing functions to include auto-save
        const originalProcessQRCode = processQRCode;
        processQRCode = function() {
            originalProcessQRCode();
            autoSaveOnChange();
        };

        const originalAdjustQuantity = adjustQuantity;
        adjustQuantity = function(id, change) {
            originalAdjustQuantity(id, change);
            autoSaveOnChange();
        };

        const originalDeleteItem = deleteItem;
        deleteItem = function(id) {
            originalDeleteItem(id);
            autoSaveOnChange();
        };

        // Initialize
        renderInventory();
        updateLastSavedTime();
    </script>
</body>
</html>